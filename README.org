#+TITLE: Flake configuration
#+AUTHOR: Tulkdan
#+EMAIL: pedro8correa@gmail.com

#+begin_src nix :tangle flake.nix :noweb yes
  {
    <<description>>

    inputs = {
      <<inputs>>
    };

    outputs = { self, nixpkgs, home-manager, ... }: let
      system = "x86_64-linux";
      hostname = "nixos";
      stateVersion = "22.11";
      pkgs = import nixpkgs {inherit system;};
      users = {
	pedro = {
		username = "pedro";
	};
      };
    in {
      <<outputs>>
    };
  }
#+end_src

** Description
#+NAME: description
#+begin_src nix
  description = "Tulk'dan's system config";
#+end_src

** Inputs
:PROPERTIES:
:header-args: :noweb-ref inputs
:END:

*** Nixpkgs

#+begin_src nix
  nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
#+end_src

*** Home Manager
#+begin_src nix
  home-manager = {
    url = "github:nix-community/home-manager";
    inputs.nixpkgs.follows = "nixpkgs";
  };
#+end_src

** Outputs
:PROPERTIES:
:header-args: :noweb-ref outputs
:END:

*** NixOS System
#+begin_src nix
  nixosConfigurations.${hostname} = nixpkgs.lib.nixosSystem {
    inherit system;

    modules = [
      ./system/configuration.nix
      home-manager.nixosModules.home-manager
      {
	home-manager = {
		useGlobalPkgs = true;
		useUserPackages = true;
		users.pedro = import ./home-manager {
			config = self;
			pkgs = pkgs;
			username = users.pedro.username;
			stateVersion = stateVersion;
		};
	};
      }
    ];
  };
#+end_src

